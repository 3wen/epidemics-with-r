<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Modelling epidemics with R - 7&nbsp; Phenomenological Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./phenomeological-background.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	     MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';
		 
		 
		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Phenomenological Models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Modelling epidemics with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/3wen/epidemics-with-r" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="./Modelling-epidemics-with-R.pdf" title="Download PDF" class="sidebar-tool px-1"><i class="bi bi-file-pdf"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">SIR Model</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SIR-background.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Theoretical background</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SIR-simulations.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Simulations with R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./SIR-animations.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Animations with R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Statistical Models</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./covid-data.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Covid-19 Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reproduction-number.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Estimating the reproduction number</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./phenomeological-background.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Background on Phenomenological Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./phenomenological-models.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Phenomenological Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#simple-phenomenological-models" id="toc-simple-phenomenological-models" class="nav-link active" data-scroll-target="#simple-phenomenological-models"><span class="toc-section-number">7.1</span>  Simple phenomenological models</a>
  <ul class="collapse">
  <li><a href="#logistic-model" id="toc-logistic-model" class="nav-link" data-scroll-target="#logistic-model"><span class="toc-section-number">7.1.1</span>  Logistic Model</a></li>
  <li><a href="#gompertz-model" id="toc-gompertz-model" class="nav-link" data-scroll-target="#gompertz-model"><span class="toc-section-number">7.1.2</span>  Gompertz Model</a></li>
  <li><a href="#richards-model" id="toc-richards-model" class="nav-link" data-scroll-target="#richards-model"><span class="toc-section-number">7.1.3</span>  Richards Model</a></li>
  <li><a href="#help-functions" id="toc-help-functions" class="nav-link" data-scroll-target="#help-functions"><span class="toc-section-number">7.1.4</span>  Help functions</a></li>
  </ul></li>
  <li><a href="#predictions-at-the-end-of-the-first-wave" id="toc-predictions-at-the-end-of-the-first-wave" class="nav-link" data-scroll-target="#predictions-at-the-end-of-the-first-wave"><span class="toc-section-number">7.2</span>  Predictions at the end of the first wave</a>
  <ul class="collapse">
  <li><a href="#example-for-the-uk" id="toc-example-for-the-uk" class="nav-link" data-scroll-target="#example-for-the-uk"><span class="toc-section-number">7.2.1</span>  Example for the UK</a></li>
  </ul></li>
  <li><a href="#double-sigmoid-functions-to-account-for-a-second-wave" id="toc-double-sigmoid-functions-to-account-for-a-second-wave" class="nav-link" data-scroll-target="#double-sigmoid-functions-to-account-for-a-second-wave"><span class="toc-section-number">7.3</span>  Double sigmoid functions to account for a second wave</a>
  <ul class="collapse">
  <li><a href="#double-logistic" id="toc-double-logistic" class="nav-link" data-scroll-target="#double-logistic"><span class="toc-section-number">7.3.1</span>  Double Logistic</a></li>
  <li><a href="#double-gompertz-model" id="toc-double-gompertz-model" class="nav-link" data-scroll-target="#double-gompertz-model"><span class="toc-section-number">7.3.2</span>  Double Gompertz Model</a></li>
  <li><a href="#double-richards-model" id="toc-double-richards-model" class="nav-link" data-scroll-target="#double-richards-model"><span class="toc-section-number">7.3.3</span>  Double Richards Model</a></li>
  <li><a href="#help-functions-1" id="toc-help-functions-1" class="nav-link" data-scroll-target="#help-functions-1"><span class="toc-section-number">7.3.4</span>  Help functions</a></li>
  <li><a href="#example-for-the-uk-1" id="toc-example-for-the-uk-1" class="nav-link" data-scroll-target="#example-for-the-uk-1"><span class="toc-section-number">7.3.5</span>  Example for the UK</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-phenomenological-models" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Phenomenological Models</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This chapter shows R codes that can be used to fit the phenomenological models, presented in <a href="phenomeological-background.html">Chapter&nbsp;<span>6</span></a>, on observed confirmed cases. It shows the codes to model a single wave, and those that can be used to model two waves.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FOR UNIX USERS </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setlocale</span>(<span class="st">"LC_ALL"</span>, <span class="st">"en_US.UTF-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FOR WINDOWS USERS</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys.setlocale("LC_ALL", "English_United States")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some packages that will be used:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'scales'

The following object is masked from 'package:purrr':

    discard

The following object is masked from 'package:readr':

    col_factor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(minpack.lm)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us load the data (results obtained from <a href="covid-data.html">Chapter&nbsp;<span>4</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/data_after_load.rda"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="simple-phenomenological-models" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="simple-phenomenological-models"><span class="header-section-number">7.1</span> Simple phenomenological models</h2>
<section id="logistic-model" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="logistic-model"><span class="header-section-number">7.1.1</span> Logistic Model</h3>
<p>In R, we define the logistic function as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Logistic function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>logistic_f <span class="ot">&lt;-</span>  <span class="cf">function</span>(theta, x) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  k <span class="sc">/</span> ( <span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>( <span class="sc">-</span>r<span class="sc">*</span>( x <span class="sc">-</span> tau ) ) )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' First derivative of the logistic function</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>logistic_f_first_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  (k <span class="sc">*</span> r <span class="sc">*</span> <span class="fu">exp</span>( <span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau) )) <span class="sc">/</span> (<span class="dv">1</span><span class="sc">+</span> <span class="fu">exp</span>( <span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau) ))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' Second derivative of the logistic function</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>logistic_f_second_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  k<span class="sc">*</span>((<span class="dv">2</span><span class="sc">*</span>r<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>r<span class="sc">*</span>(x <span class="sc">-</span> tau)))<span class="sc">/</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>       (<span class="fu">exp</span>(<span class="sc">-</span>r<span class="sc">*</span>(x <span class="sc">-</span> tau)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span> </span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>       (r<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>r<span class="sc">*</span>(x <span class="sc">-</span> tau)))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="sc">-</span>r<span class="sc">*</span>(x <span class="sc">-</span> tau)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gompertz-model" class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="gompertz-model"><span class="header-section-number">7.1.2</span> Gompertz Model</h3>
<p>In R, the Gompertz Model can be written as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Gompertz function with three parameters</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>gompertz_f <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  k<span class="sc">*</span><span class="fu">exp</span>( <span class="sc">-</span><span class="fu">exp</span>( <span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau) ) )</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' First order derivative of Gompertz wrt x</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>gompertz_f_first_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  k <span class="sc">*</span> (x <span class="sc">-</span> tau) <span class="sc">*</span> <span class="fu">exp</span>(r <span class="sc">*</span> (tau <span class="sc">-</span> x) <span class="sc">-</span> <span class="fu">exp</span>(r <span class="sc">*</span> (tau <span class="sc">-</span> x)))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' Second order derivative of Gompertz</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>gompertz_f_second_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>k <span class="sc">*</span> r<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">*</span> </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau))) <span class="sc">+</span> </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    k <span class="sc">*</span> r<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau)))<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> (x <span class="sc">-</span> tau)))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="richards-model" class="level3" data-number="7.1.3">
<h3 data-number="7.1.3" class="anchored" data-anchor-id="richards-model"><span class="header-section-number">7.1.3</span> Richards Model</h3>
<p>In R, Richards’ Model can be coded as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Richards function with four parameters</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>richards_f <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> theta[[<span class="st">"delta"</span>]]</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  k <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> delta <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r <span class="sc">*</span> delta <span class="sc">*</span> (x <span class="sc">-</span> tau)))<span class="sc">^</span>(<span class="dv">1</span> <span class="sc">/</span> delta)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' First order derivative of Richards function wrt time (x)</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>richards_f_first_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> theta[[<span class="st">"delta"</span>]]</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  delta <span class="sc">*</span> k <span class="sc">*</span> r <span class="sc">*</span> <span class="fu">exp</span>(delta <span class="sc">*</span> (<span class="sc">-</span>r) <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">*</span> </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    (delta <span class="sc">*</span> <span class="fu">exp</span>(delta <span class="sc">*</span> (<span class="sc">-</span>r) <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' Second order derivative of Richards function wrt time (x)</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x time</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>richards_f_second_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> theta[[<span class="st">"k"</span>]]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> theta[[<span class="st">"tau"</span>]]</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> theta[[<span class="st">"r"</span>]]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  delta <span class="ot">&lt;-</span> theta[[<span class="st">"delta"</span>]]</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  k <span class="sc">*</span> ((<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>         delta<span class="sc">^</span><span class="dv">3</span> <span class="sc">*</span> r<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> delta <span class="sc">*</span> r <span class="sc">*</span> (x <span class="sc">-</span> tau))) <span class="sc">*</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>         (delta <span class="sc">*</span> <span class="fu">exp</span>(delta <span class="sc">*</span> (<span class="sc">-</span>r) <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">-</span> </span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>         delta<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> r<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(delta <span class="sc">*</span> (<span class="sc">-</span>r) <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">*</span> </span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>         (delta <span class="sc">*</span> <span class="fu">exp</span>(delta <span class="sc">*</span> (<span class="sc">-</span>r) <span class="sc">*</span> (x <span class="sc">-</span> tau)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="help-functions" class="level3" data-number="7.1.4">
<h3 data-number="7.1.4" class="anchored" data-anchor-id="help-functions"><span class="header-section-number">7.1.4</span> Help functions</h3>
<p>Some functions can be helpful to fit the models both for the number of cases and deaths. First of all, we can create a function that gives the dates for the different periods:</p>
<ul>
<li><code>start_first_wave</code>: start of the first wave, defined as the first date when the cumulative number of cases is greater than 1</li>
<li><code>start_high_stringency</code>: date at which the stringency index reaches its maximum value during the first 100 days of the sample</li>
<li><code>start_reduce_restrict</code>: moment at which the restrictions of the first wave starts to lower</li>
<li><code>start_date_sample_second_wave</code>: 60 days after the relaxation of restrictions (60 days after after <code>start_reduce_restrict</code>)</li>
<li><code>length_high_stringency</code>: number of days between <code>start_high_stringency</code> and <code></code>start_reduce_restrict`.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Gives the dates of the different periods (first wave, start of containment, ...)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param country_name name of the country</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type if `"deaths"` returns the number of deaths, otherwise the number of cases</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>get_dates <span class="ot">&lt;-</span> <span class="cf">function</span>(country_name,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                      <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"cases"</span>, <span class="st">"deaths"</span>)) {</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"deaths"</span>) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> deaths_df <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> confirmed_df <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start of the first wave</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  start_first_wave <span class="ot">&lt;-</span> </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    df_country <span class="sc">|&gt;</span> </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start of period with severity greater or equal than 70 index among the first 100 days</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  start_high_stringency <span class="ot">&lt;-</span> </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    df_country <span class="sc">|&gt;</span> </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(stringency_index <span class="sc">&gt;=</span> <span class="dv">70</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Max for Sweden</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (country_name <span class="sc">==</span> <span class="st">"Sweden"</span>) {</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    start_high_stringency <span class="ot">&lt;-</span> </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(<span class="fu">desc</span>(stringency_index), date) <span class="sc">|&gt;</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>      magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Max stringency first 100 days</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  start_max_stringency <span class="ot">&lt;-</span> </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    df_country <span class="sc">|&gt;</span> </span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(stringency_index), date) <span class="sc">|&gt;</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moment at which the restrictions of the first wave starts to lower</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>  start_reduce_restrict <span class="ot">&lt;-</span> </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    df_country <span class="sc">|&gt;</span> </span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&gt;=</span> start_max_stringency) <span class="sc">|&gt;</span> </span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tmp =</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(stringency_index)) <span class="sc">|&gt;</span> </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">same_strin =</span> stringency_index <span class="sc">==</span> tmp) <span class="sc">|&gt;</span> </span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">same_strin =</span> <span class="fu">ifelse</span>(<span class="fu">row_number</span>() <span class="sc">==</span> <span class="dv">1</span>, <span class="cn">TRUE</span>, same_strin)) <span class="sc">|&gt;</span> </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(same_strin <span class="sc">==</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  start_date_sample_second_wave <span class="ot">&lt;-</span> start_reduce_restrict <span class="sc">+</span> </span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    lubridate<span class="sc">::</span><span class="fu">ddays</span>(<span class="dv">60</span>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Length of high stringency period</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  length_high_stringency <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">interval</span>(</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    start_high_stringency, start_reduce_restrict) <span class="sc">/</span> </span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    lubridate<span class="sc">::</span><span class="fu">ddays</span>(<span class="dv">1</span>)</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> country_name,</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_first_wave =</span> start_first_wave,</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_high_stringency =</span> start_high_stringency,</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_reduce_restrict =</span> start_reduce_restrict,</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_date_sample_second_wave =</span> start_date_sample_second_wave,</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">length_high_stringency =</span> length_high_stringency</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then create a function to prepare the dataset fot a given country. This function allows to provide data for:</p>
<ul>
<li>the first wave sample: between the first case and 60 days after the day at which the severity index reaches its max value (during the first 100 days) ; we also add some data for the out-of-sample prediction (of length set outside the function by <code>out_of_sample_horizon</code>)</li>
<li>the second wave sample: data posterior to 60 days after the relaxation of restrictions</li>
<li>all available data</li>
</ul>
<p>The argument <code>type</code> of the function controls whether we get number of cases or deaths.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Extracts the cases data for a country</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @description</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' If one only wants the first wave (first_wave=TRUE) the following start and</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' end date are used:</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - start: date of the first case</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - end: when the severity index is greater than 70</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param country_name name of the country</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param sample if `"first"`, returns the sample for the first wave; if "second", </span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' for the second wave, and `"all"` for all data up to the end</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param type if `"deaths"` returns the number of deaths, otherwise the number of cases</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>get_values_country <span class="ot">&lt;-</span> <span class="cf">function</span>(country_name,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">sample =</span> <span class="fu">c</span>(<span class="st">"first"</span>, <span class="st">"second"</span>, <span class="st">"all"</span>),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"cases"</span>, <span class="st">"deaths"</span>)) {</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"deaths"</span>) {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> deaths_df <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> confirmed_df <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  dates_country <span class="ot">&lt;-</span> <span class="fu">get_dates</span>(country_name, <span class="at">type =</span> type)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Maximum of the severity index</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  max_severity <span class="ot">&lt;-</span> <span class="fu">max</span>(df_country<span class="sc">$</span>stringency_index, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  dates_country<span class="sc">$</span>max_severity <span class="ot">&lt;-</span> max_severity</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sample <span class="sc">==</span> <span class="st">"first"</span>) {</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(date <span class="sc">&gt;=</span> dates_country<span class="sc">$</span>start_first_wave,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>             <span class="co"># 60 days after end max stringency in the first interval of 100 </span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>             <span class="co"># days + `out_of_sample_horizon` more days for out-of-sample pred</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>             date <span class="sc">&lt;=</span> dates_country<span class="sc">$</span>start_date_sample_second_wave <span class="sc">+</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>               lubridate<span class="sc">::</span><span class="fu">ddays</span>(out_of_sample_horizon)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>             ) </span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (sample <span class="sc">==</span> <span class="st">"second"</span>) {</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(date <span class="sc">&gt;=</span> dates_country<span class="sc">$</span>start_date_sample_second_wave)</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let us remove the number of cases of the first date of this sample</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to all observation (translation to 1)</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    start_val_cases <span class="ot">&lt;-</span> df_country<span class="sc">$</span>value[<span class="dv">1</span>]</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">value =</span> value <span class="sc">-</span> start_val_cases <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(date <span class="sc">&gt;=</span> dates_country<span class="sc">$</span>start_first_wave)</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Moving Average for missing values (i.e., for Ireland)</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">is.na</span>(df_country<span class="sc">$</span>value))) {</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    replacement_values <span class="ot">&lt;-</span> <span class="fu">round</span>(</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>      zoo<span class="sc">::</span><span class="fu">rollapply</span>(</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>        df_country<span class="sc">$</span>value, </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span><span class="dv">3</span>, </span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">FUN=</span><span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm=</span><span class="cn">TRUE</span>), </span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">by=</span><span class="dv">1</span>,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">by.column=</span><span class="cn">TRUE</span>,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">partial=</span><span class="cn">TRUE</span>,</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill=</span><span class="cn">NA</span>,</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">align=</span><span class="st">"center"</span>)</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace only missing values</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>      df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">replacement_values =</span> <span class="sc">!!</span>replacement_values) <span class="sc">|&gt;</span> </span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">value =</span> <span class="fu">ifelse</span>(</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>          <span class="fu">is.na</span>(value), </span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>          <span class="at">yes =</span> replacement_values,</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>          <span class="at">no =</span> value)</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>replacement_values)</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  df_country <span class="ot">&lt;-</span> </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    df_country <span class="sc">|&gt;</span> </span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">t =</span> <span class="fu">row_number</span>()<span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> value)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">df_country =</span> df_country, <span class="at">dates_country =</span> dates_country)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to define a loss function that will be minimized to get the estimates of the models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Loss function</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters of the model</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fun prediction function of the model</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y target variable</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param t time component (feature)</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>loss_function <span class="ot">&lt;-</span> <span class="cf">function</span>(theta,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                          fun,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                          y,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>                          t) {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  (y <span class="sc">-</span> <span class="fu">fun</span>(<span class="at">theta =</span> theta, <span class="at">x =</span> t))</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the model are estimated, we can compute some goodness of fit criteria. Let us create a function that computes the AIC, the BIC and the RMSE for a specific model. The function expects three arguments: the prediction function of the model (<code>f</code>), the values for the parameters of the model (in a named vector – <code>theta</code>), and the observations (<code>data</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute some goodness of fit criteria</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param f prediction function of the model</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data data that contains the two columns `y` and `t`</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta estimated coefficients for the model (used in `f`)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>get_criteria <span class="ot">&lt;-</span> <span class="cf">function</span>(f,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                         data,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                         theta) {</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  k <span class="ot">&lt;-</span> <span class="fu">length</span>(theta)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  w <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, n)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  errors <span class="ot">&lt;-</span> <span class="fu">loss_function</span>(<span class="at">theta =</span> theta, <span class="at">fun =</span> f, <span class="at">y =</span> data<span class="sc">$</span>y, <span class="at">t =</span> data<span class="sc">$</span>t)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  mse <span class="ot">&lt;-</span> <span class="fu">sum</span>(errors<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> n</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(mse)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Log-likelihood</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> (<span class="fu">sum</span>(<span class="fu">log</span>(w)) <span class="sc">-</span> n <span class="sc">*</span> </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>                 (<span class="fu">log</span>(<span class="dv">2</span> <span class="sc">*</span> pi) <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">log</span>(n) <span class="sc">+</span> <span class="fu">log</span>(<span class="fu">sum</span>(w <span class="sc">*</span> errors<span class="sc">^</span><span class="dv">2</span>))))</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  aic <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> (k<span class="sc">+</span><span class="dv">1</span>) <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>ll</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  bic <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> ll <span class="sc">+</span> <span class="fu">log</span>(n) <span class="sc">*</span> (k<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">AIC =</span> aic, <span class="at">BIC =</span> bic, <span class="at">RMSE =</span> rmse)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="predictions-at-the-end-of-the-first-wave" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="predictions-at-the-end-of-the-first-wave"><span class="header-section-number">7.2</span> Predictions at the end of the first wave</h2>
<p>Let us turn to the estimation of the number of cases and the estimation of the number of deaths for the first wave. Recall that the sample used is defined as follows: from the first date where the cumulative number of cases (deaths) is greater or equal to 1 to 60 days after the maximum value of the stringency index (start of containment).</p>
<p>Let us focus here first on the estimation of the Gompertz model, for the number of cased, in the UK. Then, we can wrap up the code and estimate all models to all countries.</p>
<section id="example-for-the-uk" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="example-for-the-uk"><span class="header-section-number">7.2.1</span> Example for the UK</h3>
<p>We would like to make out-of-sample predictions, to assess how the models perform with unseen data. To that end, let us define a horizon at which to look at (30 days):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>out_of_sample_horizon <span class="ot">&lt;-</span> <span class="dv">30</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us also define a limit of the number of fitted values to return:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>horizon_pred <span class="ot">&lt;-</span> <span class="dv">250</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want to focus on the UK:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>country_name <span class="ot">&lt;-</span> <span class="st">"United Kingdom"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pop_country <span class="ot">&lt;-</span> population <span class="sc">|&gt;</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"pop"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>pop_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.7e+07</code></pre>
</div>
</div>
<p>The data for the sample can be obtained using the <code class="sourceCode r"><span class="fu">get_values_country</span>()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>data_country <span class="ot">&lt;-</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_values_country</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">country_name =</span> country_name,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="st">"first"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"cases"</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>data_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$df_country
# A tibble: 192 × 8
   country  country_code date       value stringency_index days_since_2020_01_22
   &lt;chr&gt;    &lt;chr&gt;        &lt;date&gt;     &lt;int&gt;            &lt;dbl&gt;                 &lt;dbl&gt;
 1 United … GBR          2020-01-31     2             8.33                     9
 2 United … GBR          2020-02-01     2             8.33                    10
 3 United … GBR          2020-02-02     2            11.1                     11
 4 United … GBR          2020-02-03     8            11.1                     12
 5 United … GBR          2020-02-04     8            11.1                     13
 6 United … GBR          2020-02-05     9            11.1                     14
 7 United … GBR          2020-02-06     9            11.1                     15
 8 United … GBR          2020-02-07     9            11.1                     16
 9 United … GBR          2020-02-08    13            11.1                     17
10 United … GBR          2020-02-09    14            11.1                     18
# ℹ 182 more rows
# ℹ 2 more variables: t &lt;dbl&gt;, y &lt;int&gt;

$dates_country
# A tibble: 1 × 7
  country        start_first_wave start_high_stringency start_reduce_restrict
  &lt;chr&gt;          &lt;date&gt;           &lt;date&gt;                &lt;date&gt;               
1 United Kingdom 2020-01-31       2020-03-23            2020-05-11           
# ℹ 3 more variables: start_date_sample_second_wave &lt;date&gt;,
#   length_high_stringency &lt;dbl&gt;, max_severity &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We obtained both the sample to learn from and the dates of interest, in a list. Let us store those in single objects:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df_country <span class="ot">&lt;-</span> data_country<span class="sc">$</span>df_country</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dates_country <span class="ot">&lt;-</span> data_country<span class="sc">$</span>dates_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model we wish to estimate is the Gompertz model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">"Gompertz"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The different functions of the model are the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>model_function <span class="ot">&lt;-</span> gompertz_f</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>model_function_d <span class="ot">&lt;-</span> gompertz_f_first_d</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>model_function_dd <span class="ot">&lt;-</span> gompertz_f_second_d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The training sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Training sample</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>df_country_training <span class="ot">&lt;-</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  df_country <span class="sc">|&gt;</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(df_country) <span class="sc">-</span> out_of_sample_horizon))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>df_country_training</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 162 × 8
   country  country_code date       value stringency_index days_since_2020_01_22
   &lt;chr&gt;    &lt;chr&gt;        &lt;date&gt;     &lt;int&gt;            &lt;dbl&gt;                 &lt;dbl&gt;
 1 United … GBR          2020-01-31     2             8.33                     9
 2 United … GBR          2020-02-01     2             8.33                    10
 3 United … GBR          2020-02-02     2            11.1                     11
 4 United … GBR          2020-02-03     8            11.1                     12
 5 United … GBR          2020-02-04     8            11.1                     13
 6 United … GBR          2020-02-05     9            11.1                     14
 7 United … GBR          2020-02-06     9            11.1                     15
 8 United … GBR          2020-02-07     9            11.1                     16
 9 United … GBR          2020-02-08    13            11.1                     17
10 United … GBR          2020-02-09    14            11.1                     18
# ℹ 152 more rows
# ℹ 2 more variables: t &lt;dbl&gt;, y &lt;int&gt;</code></pre>
</div>
</div>
<p>Then, we can fit the model. But first, we need starting values for the optimization algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The starting values</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">k   =</span> pop_country,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau =</span> <span class="dv">80</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">r   =</span> .<span class="dv">24</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we can proceed with the estimation of the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">nls.lm</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> start, </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> loss_function,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> df_country<span class="sc">$</span>y,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">t =</span> df_country<span class="sc">$</span>t,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> model_function,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nls.lm.control</span>(<span class="at">maxiter =</span> <span class="dv">100</span>),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">jac =</span> <span class="cn">NULL</span>, </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> <span class="cn">NULL</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Parameters:
     Estimate Std. Error t value Pr(&gt;|t|)    
k   2.992e+05  6.512e+02   459.4   &lt;2e-16 ***
tau 7.587e+01  1.410e-01   538.2   &lt;2e-16 ***
r   4.296e-02  3.861e-04   111.3   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3738 on 189 degrees of freedom
Number of iterations to termination: 12 
Reason for termination: Relative error in the sum of squares is at most `ftol'. </code></pre>
</div>
</div>
<p>Let us store the estimated parameters of the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> country_name,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_estimate_name =</span> <span class="fu">names</span>(<span class="fu">coef</span>(out)),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_estimate =</span> <span class="fu">coef</span>(out)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  model_type country        coef_estimate_name coef_estimate
  &lt;chr&gt;      &lt;chr&gt;          &lt;chr&gt;                      &lt;dbl&gt;
1 Gompertz   United Kingdom k                    299189.    
2 Gompertz   United Kingdom tau                      75.9   
3 Gompertz   United Kingdom r                         0.0430</code></pre>
</div>
</div>
<p>The goodness of fit can be obtained using the previously defined function <code>get_criteria()</code>, and the results can be saved in a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Goodness of fit</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>crit <span class="ot">&lt;-</span> <span class="fu">get_criteria</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> model_function,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_country_training,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>criteria <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> country_name,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(crit)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>criteria</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  model_type country          AIC   BIC  RMSE
  &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Gompertz   United Kingdom 3049. 3062. 2885.</code></pre>
</div>
</div>
<p>Let us now turn to the out-of-sample predictions. We need to compare the predictions of the model 30 days after the end of the sample, with those that were observed (but not used in the estimation). The test sample becomes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df_country_test <span class="ot">&lt;-</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  df_country <span class="sc">|&gt;</span> </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>((<span class="fu">nrow</span>(df_country) <span class="sc">-</span> out_of_sample_horizon <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">nrow</span>(df_country)))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>df_country_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 8
   country country_code date        value stringency_index days_since_2020_01_22
   &lt;chr&gt;   &lt;chr&gt;        &lt;date&gt;      &lt;int&gt;            &lt;dbl&gt;                 &lt;dbl&gt;
 1 United… GBR          2020-07-11 288953             64.4                   171
 2 United… GBR          2020-07-12 289603             64.4                   172
 3 United… GBR          2020-07-13 290133             64.4                   173
 4 United… GBR          2020-07-14 291373             64.4                   174
 5 United… GBR          2020-07-15 291911             64.4                   175
 6 United… GBR          2020-07-16 292552             64.4                   176
 7 United… GBR          2020-07-17 293239             64.4                   177
 8 United… GBR          2020-07-18 294066             64.4                   178
 9 United… GBR          2020-07-19 294792             64.4                   179
10 United… GBR          2020-07-20 295372             64.4                   180
# ℹ 20 more rows
# ℹ 2 more variables: t &lt;dbl&gt;, y &lt;int&gt;</code></pre>
</div>
</div>
<p>The different criteria can be computed on the predictions made for that 30 days interval:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>crit_oos <span class="ot">&lt;-</span> <span class="fu">get_criteria</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> model_function, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_country_test,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>criteria_oos <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> country_name,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(crit_oos)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>criteria_oos</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  model_type country          AIC   BIC  RMSE
  &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Gompertz   United Kingdom  620.  626. 6564.</code></pre>
</div>
</div>
<p>Let us now process the data so that we know, for each observations, whether the prediction corresponds to seen or unseen data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> df_country_training<span class="sc">$</span>value</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>type_obs <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">"obs"</span>, <span class="fu">length</span>(obs))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(obs) <span class="sc">&lt;</span> horizon_pred) {</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  obs <span class="ot">&lt;-</span> <span class="fu">c</span>(obs, <span class="fu">rep</span>(<span class="cn">NA</span>, horizon_pred<span class="sc">-</span><span class="fu">length</span>(obs)))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  type_obs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    type_obs,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">"out_of_sample"</span>, horizon_pred <span class="sc">-</span> <span class="fu">length</span>(type_obs))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 2 2 8 8 9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA NA NA NA NA NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 250</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "obs" "obs" "obs" "obs" "obs" "obs"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "out_of_sample" "out_of_sample" "out_of_sample" "out_of_sample"
[5] "out_of_sample" "out_of_sample"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 250</code></pre>
</div>
</div>
<p>Let us create a vector of corresponding dates for those:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> df_country_training<span class="sc">$</span>date</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(dates) <span class="sc">&lt;</span> horizon_pred) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  dates <span class="ot">&lt;-</span> dates[<span class="dv">1</span>] <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">ddays</span>(<span class="fu">seq_len</span>(horizon_pred) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-01-31" "2020-02-01" "2020-02-02" "2020-02-03" "2020-02-04"
[6] "2020-02-05"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-10-01" "2020-10-02" "2020-10-03" "2020-10-04" "2020-10-05"
[6] "2020-10-06"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 250</code></pre>
</div>
</div>
<p>Then, the predictions obtained with the model can be saved in a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fitted_val <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">country  =</span> <span class="sc">!!</span>country_name,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">index    =</span> <span class="fu">seq_len</span>(horizon_pred) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value    =</span> obs,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_obs =</span> type_obs,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">date     =</span> dates</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_type   =</span> model_name,</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fitted_value =</span> <span class="fu">model_function</span>(</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> index)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>fitted_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 250 × 7
   country        index value type_obs date       model_type fitted_value
   &lt;chr&gt;          &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;date&gt;     &lt;chr&gt;             &lt;dbl&gt;
 1 United Kingdom     0     2 obs      2020-01-31 Gompertz     0.00000149
 2 United Kingdom     1     2 obs      2020-02-01 Gompertz     0.00000446
 3 United Kingdom     2     2 obs      2020-02-02 Gompertz     0.0000127 
 4 United Kingdom     3     8 obs      2020-02-03 Gompertz     0.0000347 
 5 United Kingdom     4     8 obs      2020-02-04 Gompertz     0.0000909 
 6 United Kingdom     5     9 obs      2020-02-05 Gompertz     0.000228  
 7 United Kingdom     6     9 obs      2020-02-06 Gompertz     0.000552  
 8 United Kingdom     7     9 obs      2020-02-07 Gompertz     0.00129   
 9 United Kingdom     8    13 obs      2020-02-08 Gompertz     0.00289   
10 United Kingdom     9    14 obs      2020-02-09 Gompertz     0.00628   
# ℹ 240 more rows</code></pre>
</div>
</div>
<p>Using the second order derivative with respect to time of the model, we can compute the three key moments, and store those in a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Key moments</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> out<span class="sc">$</span>par<span class="sc">$</span>tau</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># First wave</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>acceleration <span class="ot">&lt;-</span> <span class="fu">model_function_dd</span>(</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">1</span>, tau)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">which.max</span>()</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>deceleration <span class="ot">&lt;-</span> tau <span class="sc">+</span> </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">seq</span>(tau, horizon_pred)</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> <span class="fu">which.min</span>()</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Peak</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>abs_second_d_vals <span class="ot">&lt;-</span> <span class="fu">abs</span>(</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(acceleration, deceleration)</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>abs_second_d_vals <span class="ot">&lt;-</span> abs_second_d_vals <span class="sc">/</span> <span class="fu">min</span>(abs_second_d_vals)</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>peak <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">which</span>(abs_second_d_vals <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">+</span> acceleration</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Relative speed at max speed</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>relative_speed <span class="ot">&lt;-</span> <span class="fu">model_function_d</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak) <span class="sc">/</span></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>key_moments <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">country  =</span> country_name,</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">t =</span> <span class="fu">round</span>(<span class="fu">c</span>(acceleration, peak, deceleration)),</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">model_function</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, t),</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">moment =</span> <span class="fu">c</span>(<span class="st">"acceleration"</span>, <span class="st">"peak"</span>, <span class="st">"deceleration"</span>)</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">country =</span> country_name,</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> model_name,</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">t =</span> peak,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> relative_speed,</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">moment =</span> <span class="st">"relative_speed"</span></span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">first</span>(df_country_training<span class="sc">$</span>date) <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">ddays</span>(t) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>key_moments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  country        model_type     t     value moment         date      
  &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;          &lt;date&gt;    
1 United Kingdom Gompertz      53  20708.   acceleration   2020-03-23
2 United Kingdom Gompertz      77 115420.   peak           2020-04-16
3 United Kingdom Gompertz      99 206618.   deceleration   2020-05-08
4 United Kingdom Gompertz      77      1.08 relative_speed 2020-04-16</code></pre>
</div>
</div>
<p>We can plot the results showing observed values and predicted ones. First, let us prepare the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>the_dates <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="st">"United Kingdom"</span>, get_dates, <span class="at">type =</span> <span class="st">"cases"</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>df_key_moments <span class="ot">&lt;-</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    key_moments <span class="sc">|&gt;</span> </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(colour_table, <span class="at">by =</span> <span class="st">"country"</span>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> </span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>  fitted_val <span class="sc">|&gt;</span> </span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(value, fitted_value)) <span class="sc">|&gt;</span> </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> (type_obs <span class="sc">==</span> <span class="st">"out_of_sample"</span> <span class="sc">&amp;</span> name <span class="sc">==</span> <span class="st">"value"</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">linetype =</span> <span class="fu">str_c</span>(type_obs, <span class="st">"_"</span>, name)) <span class="sc">|&gt;</span> </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">ifelse</span>(</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>      linetype <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"obs_value"</span>, <span class="st">"out_of_sample_value"</span>),</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">yes =</span> <span class="st">"obs"</span>,</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">no =</span> linetype</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country, date, value, linetype)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span> </span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span> </span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(colour_table, <span class="at">by =</span> <span class="st">"country"</span>) <span class="sc">|&gt;</span>   </span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">factor</span>(</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>      linetype, </span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"obs"</span>, <span class="st">"obs_fitted_value"</span>, <span class="st">"out_of_sample_fitted_value"</span>),</span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Obs."</span>, <span class="st">"Fitted values"</span>, <span class="st">"Predictions"</span>)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>df_dots <span class="ot">&lt;-</span> </span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>  the_dates <span class="sc">|&gt;</span> </span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">end_sample =</span> start_reduce_restrict <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">ddays</span>(<span class="dv">60</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>    df_plot <span class="sc">|&gt;</span> </span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(linetype <span class="sc">==</span> <span class="st">"Obs."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(country, date, value), </span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"end_sample"</span> <span class="ot">=</span> <span class="st">"date"</span>, <span class="st">"country"</span> <span class="ot">=</span> <span class="st">"country"</span>)</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(colour_table, <span class="at">by =</span> <span class="st">"country"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then we can plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_plot) <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> date, <span class="at">y =</span> value,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> country_code, <span class="at">linetype =</span> linetype)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> df_dots,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> end_sample, <span class="at">y =</span> value,</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">colour =</span> country_code),</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> <span class="dv">2</span>,</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> df_key_moments,</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> date, <span class="at">y =</span> value,</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> country_code</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="cn">NULL</span>, <span class="at">values =</span> colour_countries) <span class="sc">+</span></span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cases"</span>) <span class="sc">+</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">date_format</span>(<span class="st">"%b %d"</span>),</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(lubridate<span class="sc">::</span><span class="fu">pretty_dates</span>(df_plot<span class="sc">$</span>date, <span class="at">n =</span> <span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span>,</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Obs."</span> <span class="ot">=</span> <span class="st">"solid"</span>,</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Fitted values"</span> <span class="ot">=</span> <span class="st">"dashed"</span>,</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Predictions"</span> <span class="ot">=</span> <span class="st">"dotted"</span>)) <span class="sc">+</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_paper</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pred-gompertz-uk-simple" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="phenomenological-models_files/figure-html/fig-pred-gompertz-uk-simple-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7.1: Prediction of cases using the Gompertz model, for the UK (single wave)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>In <a href="#fig-pred-gompertz-uk-simple">Figure&nbsp;<span>7.1</span></a>, big dots represent the three stages of the epidemic. A triangle indicates the end of the estimation period corresponding to 60 days after the end of the most severe confinement. The Solid line corresponds to the observed series and dotted lines the predictions using Gompertz model.</p>
</section>
</section>
<section id="double-sigmoid-functions-to-account-for-a-second-wave" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="double-sigmoid-functions-to-account-for-a-second-wave"><span class="header-section-number">7.3</span> Double sigmoid functions to account for a second wave</h2>
<p>Let us now turn to double sigmoid functions to model two waves of the epidemic.</p>
<section id="double-logistic" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="double-logistic"><span class="header-section-number">7.3.1</span> Double Logistic</h3>
<p>The double logistic function, its first and second derivatives with respect to time can be coded as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Double logistic</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>double_logistic_f <span class="ot">&lt;-</span>  <span class="cf">function</span>(theta, x) {</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  (K1<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))) <span class="sc">+</span> ((K2 <span class="sc">-</span> K1)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2))))</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Double logistic in two parts</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>double_logistic_f_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  f_1 <span class="ot">&lt;-</span> K1 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>  f_2 <span class="ot">&lt;-</span> (K2 <span class="sc">-</span> K1)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">f_1 =</span> f_1, <span class="at">f_2 =</span> f_2)</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a><span class="co"># First derivative</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>double_logistic_f_first_d <span class="ot">&lt;-</span>  <span class="cf">function</span>(theta, x) {</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>  (r1 <span class="sc">*</span> K1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1))) <span class="sc">/</span> ((<span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x<span class="sc">-</span>tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>    (r2 <span class="sc">*</span> (K2<span class="sc">-</span>K1) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2))) <span class="sc">/</span> ((<span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x<span class="sc">-</span>tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Second derivative</span></span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>double_logistic_f_second_d <span class="ot">&lt;-</span>  <span class="cf">function</span>(theta, x) {</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>  K1 <span class="sc">*</span>  ((<span class="dv">2</span> <span class="sc">*</span> r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span> </span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>           ( r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>    (K2<span class="sc">-</span>K1) <span class="sc">*</span>  </span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>    ((<span class="dv">2</span> <span class="sc">*</span> r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">3</span> <span class="sc">-</span> </span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>       ( r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))<span class="sc">/</span>(<span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="double-gompertz-model" class="level3" data-number="7.3.2">
<h3 data-number="7.3.2" class="anchored" data-anchor-id="double-gompertz-model"><span class="header-section-number">7.3.2</span> Double Gompertz Model</h3>
<p>The double Gompertz function, its first and second derivatives with respect to time can be coded as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Double-Gompertz function</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param theta vector of named parameters</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x observation / training example</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>double_gompertz_f <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  f_1 <span class="ot">&lt;-</span> K1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  f_2 <span class="ot">&lt;-</span> (K2<span class="sc">-</span>K1) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  f_1 <span class="sc">+</span> f_2</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' Double-Gompertz function in two parts</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>double_gompertz_f_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>  f_1 <span class="ot">&lt;-</span> K1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>  f_2 <span class="ot">&lt;-</span> (K2<span class="sc">-</span>K1) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x<span class="sc">-</span>tau2)))</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">f_1 =</span> f_1, <span class="at">f_2 =</span> f_2)</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' First derivative</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>double_gompertz_f_first_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>  f_1_d <span class="ot">&lt;-</span> r1 <span class="sc">*</span> K1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1) <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span> r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>  f_2_d <span class="ot">&lt;-</span> r2 <span class="sc">*</span> (K2<span class="sc">-</span>K1) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2) <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span> r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))</span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>  f_1_d <span class="sc">+</span> f_2_d</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a><span class="co">#' Second derivative</span></span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a>double_gompertz_f_second_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>K1 <span class="sc">*</span> r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1<span class="sc">*</span>(x <span class="sc">-</span> tau1)) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r1<span class="sc">*</span>(x <span class="sc">-</span> tau1))) <span class="sc">+</span></span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a>    K1 <span class="sc">*</span> r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">exp</span>( <span class="sc">-</span>r1<span class="sc">*</span>(x <span class="sc">-</span> tau1)))<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r1<span class="sc">*</span>(x <span class="sc">-</span> tau1))) <span class="sc">-</span> </span>
<span id="cb65-60"><a href="#cb65-60" aria-hidden="true" tabindex="-1"></a>    (K2 <span class="sc">-</span> K1) <span class="sc">*</span> r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>( <span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">*</span> <span class="fu">exp</span>( <span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r2<span class="sc">*</span>(x <span class="sc">-</span> tau2))) <span class="sc">+</span></span>
<span id="cb65-61"><a href="#cb65-61" aria-hidden="true" tabindex="-1"></a>    (K2 <span class="sc">-</span> K1) <span class="sc">*</span> r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="fu">exp</span>( <span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>r2<span class="sc">*</span>(x<span class="sc">-</span>tau2)))</span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="double-richards-model" class="level3" data-number="7.3.3">
<h3 data-number="7.3.3" class="anchored" data-anchor-id="double-richards-model"><span class="header-section-number">7.3.3</span> Double Richards Model</h3>
<p>The double Richards function, its first and second derivatives with respect to time can be coded as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Double Richards</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>double_richards_f <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> theta[[<span class="st">"delta1"</span>]]</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> theta[[<span class="st">"delta2"</span>]]</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>  K1 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> delta1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta1) <span class="sc">+</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    (K2 <span class="sc">-</span> K1) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> delta2 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta2)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' Double Richards in two parts</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>double_richards_f_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> theta[[<span class="st">"delta1"</span>]]</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> theta[[<span class="st">"delta2"</span>]]</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  f_1 <span class="ot">&lt;-</span> K1 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> delta1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta1)</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>  f_2 <span class="ot">&lt;-</span> (K2 <span class="sc">-</span> K1) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">+</span> delta2 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)))<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta2)</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">x =</span> x, <span class="at">f_1 =</span> f_1, <span class="at">f_2 =</span> f_2)</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' First derivative</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>double_richards_f_first_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> theta[[<span class="st">"delta1"</span>]]</span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> theta[[<span class="st">"delta2"</span>]]</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a>  r1 <span class="sc">*</span> K1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">*</span> </span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>    (delta1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta1 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>    r2 <span class="sc">*</span> (K2<span class="sc">-</span>K1) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">*</span> </span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>    (delta2 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta2 <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="co">#' Second derivative</span></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>double_richards_f_second_d <span class="ot">&lt;-</span> <span class="cf">function</span>(theta, x) {</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>  K1 <span class="ot">&lt;-</span> theta[[<span class="st">"K1"</span>]]</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>  tau1 <span class="ot">&lt;-</span> theta[[<span class="st">"tau1"</span>]]</span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>  r1 <span class="ot">&lt;-</span> theta[[<span class="st">"r1"</span>]]</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>  delta1 <span class="ot">&lt;-</span> theta[[<span class="st">"delta1"</span>]]</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>  K2 <span class="ot">&lt;-</span> theta[[<span class="st">"K2"</span>]]</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a>  tau2 <span class="ot">&lt;-</span> theta[[<span class="st">"tau2"</span>]]</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a>  r2 <span class="ot">&lt;-</span> theta[[<span class="st">"r2"</span>]]</span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a>  delta2 <span class="ot">&lt;-</span> theta[[<span class="st">"delta2"</span>]]</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>  K1 <span class="sc">*</span> (r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta1 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> delta1 <span class="sc">*</span> (<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1))) <span class="sc">*</span> </span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>          (delta1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta1 <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">-</span> r1<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> </span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a>          <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">*</span> </span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a>          (delta1 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r1 <span class="sc">*</span> (x <span class="sc">-</span> tau1)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta1 <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a>    (K2 <span class="sc">-</span> K1) <span class="sc">*</span> </span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>    (r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> (<span class="sc">-</span><span class="dv">1</span> <span class="sc">/</span> delta2 <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> </span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a>       delta2 <span class="sc">*</span> (<span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2))) <span class="sc">*</span> </span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a>       (delta2 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta2 <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">-</span> </span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>       r2<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> </span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>       <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">*</span> </span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>       (delta2 <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>r2 <span class="sc">*</span> (x <span class="sc">-</span> tau2)) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">^</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>delta2 <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="help-functions-1" class="level3" data-number="7.3.4">
<h3 data-number="7.3.4" class="anchored" data-anchor-id="help-functions-1"><span class="header-section-number">7.3.4</span> Help functions</h3>
<p>Once again, we will rely on some help functions. These were defined previously:</p>
<ul>
<li><code>get_dates()</code>: returns the dates relative to the sample of a specific country</li>
<li><code>get_values_country()</code>: returns the sample data for a single country</li>
<li><code>loss_function()</code>: the loss function that is minimized to find the model estimates</li>
<li><code>get_criteria()</code>: returns goodness of fit criteria for a model estimated with nls.lm.</li>
</ul>
</section>
<section id="example-for-the-uk-1" class="level3" data-number="7.3.5">
<h3 data-number="7.3.5" class="anchored" data-anchor-id="example-for-the-uk-1"><span class="header-section-number">7.3.5</span> Example for the UK</h3>
<p>Let us consider an example, as was done for the first wave: that of the UK. The next section will show how the code can be used to estimate all the three double sigmoid models to each country.</p>
<p>First, we need to decide the time horizon for the fitted values that will be returned. If the horizon is greater than the end of observed values, we will return out-of-sample predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>end_date_sample <span class="ot">&lt;-</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(<span class="st">"2020-09-28"</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>end_date_data <span class="ot">&lt;-</span> <span class="fu">max</span>(confirmed_df<span class="sc">$</span>date)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>out_of_sample_horizon <span class="ot">&lt;-</span> <span class="fu">seq</span>(end_date_sample, end_date_data, <span class="at">by =</span> <span class="st">"day"</span>) <span class="sc">|&gt;</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">length</span>()</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>horizon_pred <span class="ot">&lt;-</span> <span class="dv">310</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, we want to focus on the UK:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>country_name <span class="ot">&lt;-</span> <span class="st">"United Kingdom"</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>pop_country <span class="ot">&lt;-</span> </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  population <span class="sc">|&gt;</span> <span class="fu">filter</span>(country <span class="sc">==</span> <span class="sc">!!</span>country_name) <span class="sc">|&gt;</span> </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"pop"</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>pop_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.7e+07</code></pre>
</div>
</div>
<p>Let us show here how we can fit a Double Gompertz model, on the number of confirmed cases:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">"Double_Gompertz"</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>type <span class="ot">&lt;-</span> <span class="st">"cases"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting the <code>sample</code> argument in our function <code>get_values_country()</code> allows us to extract the whole sample for a specific country. We can then store each element of the returned list in a single variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>data_country <span class="ot">&lt;-</span> <span class="fu">get_values_country</span>(</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  country_name, </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample =</span> <span class="st">"all"</span>, </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> type</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The training sample:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>df_country <span class="ot">&lt;-</span> data_country<span class="sc">$</span>df_country</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>df_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
   country  country_code date       value stringency_index days_since_2020_01_22
   &lt;chr&gt;    &lt;chr&gt;        &lt;date&gt;     &lt;int&gt;            &lt;dbl&gt;                 &lt;dbl&gt;
 1 United … GBR          2020-01-31     2             8.33                     9
 2 United … GBR          2020-02-01     2             8.33                    10
 3 United … GBR          2020-02-02     2            11.1                     11
 4 United … GBR          2020-02-03     8            11.1                     12
 5 United … GBR          2020-02-04     8            11.1                     13
 6 United … GBR          2020-02-05     9            11.1                     14
 7 United … GBR          2020-02-06     9            11.1                     15
 8 United … GBR          2020-02-07     9            11.1                     16
 9 United … GBR          2020-02-08    13            11.1                     17
10 United … GBR          2020-02-09    14            11.1                     18
# ℹ 265 more rows
# ℹ 2 more variables: t &lt;dbl&gt;, y &lt;int&gt;</code></pre>
</div>
</div>
<p>And the dates of interest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dates_country <span class="ot">&lt;-</span> data_country<span class="sc">$</span>dates_country</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>dates_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
  country        start_first_wave start_high_stringency start_reduce_restrict
  &lt;chr&gt;          &lt;date&gt;           &lt;date&gt;                &lt;date&gt;               
1 United Kingdom 2020-01-31       2020-03-23            2020-05-11           
# ℹ 3 more variables: start_date_sample_second_wave &lt;date&gt;,
#   length_high_stringency &lt;dbl&gt;, max_severity &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We previoulsy defined the Double Gompertz function and its first and second order derivatives. Let us use these:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>model_function <span class="ot">&lt;-</span> double_gompertz_f</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>model_function_2 <span class="ot">&lt;-</span> double_logistic_f_2</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>model_function_d <span class="ot">&lt;-</span> double_gompertz_f_first_d</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>model_function_dd <span class="ot">&lt;-</span> double_gompertz_f_second_d</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The training sample is the whole sample here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>df_country_training <span class="ot">&lt;-</span> df_country</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us set a bounding value for <span class="math inline">\(\tau_2\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>nf_tau <span class="ot">&lt;-</span> <span class="dv">280</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some starting values for the optimization algorithm:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">K1     =</span> <span class="fu">last</span>(df_country<span class="sc">$</span>y)<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau1   =</span> <span class="dv">70</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">r1     =</span> .<span class="dv">12</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">K2     =</span> <span class="fu">last</span>(df_country<span class="sc">$</span>y),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tau2   =</span> <span class="dv">200</span>,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">r2     =</span> <span class="fl">0.05</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the constraints that we set on the parameters of the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>lower_c <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">K1 =</span> <span class="dv">0</span>, <span class="at">tau1 =</span> <span class="dv">50</span>, <span class="at">r1 =</span> <span class="dv">0</span>,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">K2 =</span> <span class="dv">0</span>, <span class="at">tau2 =</span> <span class="dv">0</span>,  <span class="at">r2 =</span> <span class="dv">0</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>upper_c <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">K1 =</span> pop_country, <span class="at">tau1 =</span> <span class="cn">Inf</span>,    <span class="at">r1 =</span> <span class="cn">Inf</span>,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">K2 =</span> pop_country, <span class="at">tau2 =</span> nf_tau, <span class="at">r2 =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then use the <code>nls.lm()</code> function to minimize the loss function (<code>loss_function()</code>) for the Double Gompertz model whose function is stored in <code>model_function()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">nls.lm</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">par =</span> start,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fn =</span> loss_function,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> df_country<span class="sc">$</span>y,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">t =</span> df_country<span class="sc">$</span>t,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">fun =</span> model_function,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower =</span> lower_c,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper =</span> upper_c,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nls.lm.control</span>(<span class="at">maxiter =</span> <span class="dv">250</span>),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">jac=</span><span class="cn">NULL</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimates can be stored in a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> country_name,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_estimate_name =</span> <span class="fu">names</span>(<span class="fu">coef</span>(out)),</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_estimate =</span> <span class="fu">coef</span>(out)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  model_type      country        coef_estimate_name coef_estimate
  &lt;chr&gt;           &lt;chr&gt;          &lt;chr&gt;                      &lt;dbl&gt;
1 Double_Gompertz United Kingdom K1                   315516.    
2 Double_Gompertz United Kingdom tau1                     77.6   
3 Double_Gompertz United Kingdom r1                        0.0371
4 Double_Gompertz United Kingdom K2                  2510392.    
5 Double_Gompertz United Kingdom tau2                    280     
6 Double_Gompertz United Kingdom r2                        0.0266</code></pre>
</div>
</div>
<p>The goodness of fit can be obtained using the <code>get_criteria()</code> function that was previously defined:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>crit <span class="ot">&lt;-</span> <span class="fu">get_criteria</span>(</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">f =</span> model_function,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_country_training,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>criteria <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> country_name,</span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(crit)</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>criteria</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 5
  model_type      country          AIC   BIC  RMSE
  &lt;chr&gt;           &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Double_Gompertz United Kingdom 5817. 5842. 9239.</code></pre>
</div>
</div>
<p>Now, let us get the fitted values, up to the desired horizon as set in <code>horizon_pred</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed values</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> df_country_training<span class="sc">$</span>value</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>type_obs <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="st">"obs"</span>, <span class="fu">length</span>(obs))</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(obs) <span class="sc">&lt;</span> horizon_pred) {</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  obs <span class="ot">&lt;-</span> <span class="fu">c</span>(obs, <span class="fu">rep</span>(<span class="cn">NA</span>, horizon_pred<span class="sc">-</span><span class="fu">length</span>(obs)))</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  type_obs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    type_obs, </span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="st">"out_of_sample"</span>, horizon_pred<span class="sc">-</span><span class="fu">length</span>(type_obs))</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 2 2 8 8 9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] NA NA NA NA NA NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 310</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "obs" "obs" "obs" "obs" "obs" "obs"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "out_of_sample" "out_of_sample" "out_of_sample" "out_of_sample"
[5] "out_of_sample" "out_of_sample"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(type_obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 310</code></pre>
</div>
</div>
<p>The corresponding dates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> df_country_training<span class="sc">$</span>date</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(dates) <span class="sc">&lt;</span> horizon_pred) {</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  dates <span class="ot">&lt;-</span> dates[<span class="dv">1</span>] <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">ddays</span>(<span class="fu">seq_len</span>(horizon_pred) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-01-31" "2020-02-01" "2020-02-02" "2020-02-03" "2020-02-04"
[6] "2020-02-05"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2020-11-30" "2020-12-01" "2020-12-02" "2020-12-03" "2020-12-04"
[6] "2020-12-05"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(dates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 310</code></pre>
</div>
</div>
<p>The fitted values can be stored in a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>fitted_val <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">country  =</span> <span class="sc">!!</span>country_name,</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">index    =</span> <span class="fu">seq_len</span>(horizon_pred) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">value    =</span> obs,</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_obs =</span> type_obs,</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">date     =</span> dates</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">model_type   =</span> model_name,</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fitted_value =</span> <span class="fu">model_function</span>(<span class="at">theta =</span> params<span class="sc">$</span>coef_estimate, <span class="at">x =</span> index)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>fitted_val</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 310 × 7
   country        index value type_obs date       model_type      fitted_value
   &lt;chr&gt;          &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;    &lt;date&gt;     &lt;chr&gt;                  &lt;dbl&gt;
 1 United Kingdom     0     2 obs      2020-01-31 Double_Gompertz      0.00630
 2 United Kingdom     1     2 obs      2020-02-01 Double_Gompertz      0.0120 
 3 United Kingdom     2     2 obs      2020-02-02 Double_Gompertz      0.0224 
 4 United Kingdom     3     8 obs      2020-02-03 Double_Gompertz      0.0407 
 5 United Kingdom     4     8 obs      2020-02-04 Double_Gompertz      0.0725 
 6 United Kingdom     5     9 obs      2020-02-05 Double_Gompertz      0.126  
 7 United Kingdom     6     9 obs      2020-02-06 Double_Gompertz      0.216  
 8 United Kingdom     7     9 obs      2020-02-07 Double_Gompertz      0.362  
 9 United Kingdom     8    13 obs      2020-02-08 Double_Gompertz      0.596  
10 United Kingdom     9    14 obs      2020-02-09 Double_Gompertz      0.963  
# ℹ 300 more rows</code></pre>
</div>
</div>
<p>We can also add the two components of the sigmoid, separately:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>fitted_val <span class="ot">&lt;-</span> </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  fitted_val <span class="sc">|&gt;</span> </span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_1 =</span> <span class="fu">model_function_2</span>(<span class="at">x =</span> index, <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate)[[<span class="st">"f_1"</span>]],</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_2 =</span> <span class="fu">model_function_2</span>(<span class="at">x =</span> index, <span class="at">theta =</span> params<span class="sc">$</span>coef_estimate)[[<span class="st">"f_2"</span>]]</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key moments can be computed, using the second derivative of the model function.</p>
<p>For the first wave, the acceleration point corresponds to the moment where the second derivative reaches its maximum value. We therefore look at the time between the outbreak and the midpoint of the second wave where the second derivative reaches its maximum.</p>
<p>Let us first get the midpoints of the sigmoids:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimated midpoints of the sigmoids</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>tau_1 <span class="ot">&lt;-</span> out<span class="sc">$</span>par<span class="sc">$</span>tau1</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>tau_2 <span class="ot">&lt;-</span> out<span class="sc">$</span>par<span class="sc">$</span>tau2</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tau_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 77.56061</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tau_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 280</code></pre>
</div>
</div>
<p>Then we can compute the acceleration point:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>acceleration_wave_1 <span class="ot">&lt;-</span> <span class="fu">model_function_dd</span>(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="dv">1</span>, tau_1)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.max</span>()</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>acceleration_wave_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 52</code></pre>
</div>
</div>
<p>The deceleration point corresponds to the moment at which we observe the minimum acceleration:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>deceleration_wave_1 <span class="ot">&lt;-</span> </span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  tau_1 <span class="sc">+</span> <span class="fu">model_function_dd</span>(</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">seq</span>(tau_1, tau_2)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.min</span>()</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>deceleration_wave_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 104.5606</code></pre>
</div>
</div>
<p>Then we can compute the peak of the first wave, where the acceleration is null:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>abs_second_d_vals <span class="ot">&lt;-</span> <span class="fu">abs</span>(</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(acceleration_wave_1, deceleration_wave_1)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>abs_second_d_vals <span class="ot">&lt;-</span> abs_second_d_vals <span class="sc">/</span> <span class="fu">min</span>(abs_second_d_vals)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>peak_1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">which</span>(abs_second_d_vals <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">+</span> acceleration_wave_1</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>peak_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 79</code></pre>
</div>
</div>
<p>For the second wave, the acceleration is the moment where we observe the maximum acceleration. We look at the second derivative of the model after the deleceration of the first wave:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>acceleration_wave_2 <span class="ot">&lt;-</span> </span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  deceleration_wave_1 <span class="sc">+</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par, </span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(deceleration_wave_1, <span class="fu">last</span>(df_country_training<span class="sc">$</span>t))</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The deceleration:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>deceleration_wave_2 <span class="ot">&lt;-</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  acceleration_wave_2 <span class="sc">+</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par, </span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(acceleration_wave_2, horizon_pred)</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">which.min</span>()</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>deceleration_wave_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 310.5606</code></pre>
</div>
</div>
<p>And lastly, the peak of the second wave:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>peak_2 <span class="ot">&lt;-</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function_dd</span>(</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">theta =</span> out<span class="sc">$</span>par,</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span>(acceleration_wave_2, deceleration_wave_2)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">abs</span>()</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>peak_2 <span class="ot">&lt;-</span> <span class="fu">which</span>(peak_2 <span class="sc">&lt;</span> <span class="dv">10</span>) <span class="sc">|&gt;</span> </span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>()</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>peak_2 <span class="ot">&lt;-</span> peak_2 <span class="sc">+</span> acceleration_wave_2</span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>peak_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 281.0606</code></pre>
</div>
</div>
<p>We can also add the relative speed at each peak. For the first wave:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>relative_speed_1 <span class="ot">&lt;-</span> <span class="fu">model_function_d</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak_1) <span class="sc">/</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak_1)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>relative_speed_1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03514423</code></pre>
</div>
</div>
<p>and for the second:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>relative_speed_2 <span class="ot">&lt;-</span> <span class="fu">model_function_d</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak_2) <span class="sc">/</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model_function</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, <span class="at">x =</span> peak_2)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>relative_speed_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01873886</code></pre>
</div>
</div>
<p>These moments can be stored in a table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>key_moments <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">country  =</span> country_name,</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_type =</span> model_name,</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">t =</span> <span class="fu">c</span>(</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    acceleration_wave_1, peak_1, deceleration_wave_1,</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    acceleration_wave_2, peak_2, deceleration_wave_2</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">model_function</span>(<span class="at">theta =</span> out<span class="sc">$</span>par, t),</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">moment =</span> <span class="fu">c</span>(</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"acceleration 1"</span>, <span class="st">"peak 1"</span>, <span class="st">"deceleration 1"</span>,</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"acceleration 2"</span>, <span class="st">"peak 2"</span>, <span class="st">"deceleration 2"</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">country =</span> country_name,</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> model_name,</span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">t =</span> <span class="fu">c</span>(peak_1, peak_2),</span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">c</span>(relative_speed_1, relative_speed_2),</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">moment =</span> <span class="fu">c</span>(<span class="st">"relative speed 1"</span>, <span class="st">"relative speed 2"</span>)</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">first</span>(df_country_training<span class="sc">$</span>date) <span class="sc">+</span> lubridate<span class="sc">::</span><span class="fu">ddays</span>(t) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>key_moments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 6
  country        model_type          t        value moment   date               
  &lt;chr&gt;          &lt;chr&gt;           &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;    &lt;dttm&gt;             
1 United Kingdom Double_Gompertz   52    23923.     acceler… 2020-03-22 23:59:59
2 United Kingdom Double_Gompertz   79   122263.     peak 1   2020-04-18 23:59:59
3 United Kingdom Double_Gompertz  105.  218473.     deceler… 2020-05-14 13:27:15
4 United Kingdom Double_Gompertz  245.  483560.     acceler… 2020-10-01 13:27:15
5 United Kingdom Double_Gompertz  281. 1145566.     peak 2   2020-11-07 01:27:15
6 United Kingdom Double_Gompertz  311. 1723791.     deceler… 2020-12-06 13:27:15
7 United Kingdom Double_Gompertz   79        0.0351 relativ… 2020-04-18 23:59:59
8 United Kingdom Double_Gompertz  281.       0.0187 relativ… 2020-11-07 01:27:15</code></pre>
</div>
</div>
<p>Let us prepare the data to make a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>the_dates <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="st">"United Kingdom"</span>, get_dates, <span class="at">type =</span> <span class="st">"cases"</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  fitted_val <span class="sc">|&gt;</span> </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(value, fitted_value)) <span class="sc">|&gt;</span> </span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> (type_obs <span class="sc">==</span> <span class="st">"out_of_sample"</span> <span class="sc">&amp;</span> name <span class="sc">==</span> <span class="st">"value"</span>) ) <span class="sc">|&gt;</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">linetype =</span> <span class="fu">str_c</span>(type_obs, <span class="st">"_"</span>, name)) <span class="sc">|&gt;</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="fu">factor</span>(</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>      linetype,</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs_value"</span>,</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"obs_fitted_value"</span>, </span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"out_of_sample_fitted_value"</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Obs."</span>, </span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Double Gompertz"</span>,</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Double Gompertz"</span></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>df_plot <span class="ot">&lt;-</span></span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span> </span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>    colour_table,</span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>     <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country"</span>)</span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>date_end_obs <span class="ot">&lt;-</span> </span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>  df_plot <span class="sc">|&gt;</span> </span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(linetype <span class="sc">==</span> <span class="st">"Obs."</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">|&gt;</span> </span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>  magrittr<span class="sc">::</span><span class="fu">extract2</span>(<span class="st">"date"</span>)</span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>date_end_sample <span class="ot">&lt;-</span> <span class="fu">max</span>(df_plot<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And the plot. The shaded area corresponds to out-of-sample predictions, starting with the end of the observed data (<em>i.e.</em>, September 28).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> df_plot) <span class="sc">+</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> date, <span class="at">y =</span> value,</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> country_code, <span class="at">linetype =</span> linetype</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_manual</span>(<span class="cn">NULL</span>, <span class="at">values =</span> colour_countries) <span class="sc">+</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Cases"</span>) <span class="sc">+</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_date</span>(</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">date_format</span>(<span class="st">"%b %d %Y"</span>),</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">breaks =</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(lubridate<span class="sc">::</span><span class="fu">pretty_dates</span>(df_plot<span class="sc">$</span>date, <span class="at">n =</span> <span class="dv">5</span>))</span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_linetype_manual(</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   NULL,</span></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   values = c(</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     "Obs." = "solid",</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     "Double Richards" = "dashed",</span></span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     "Double Gompertz" = "dotted"</span></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   )</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ) +</span></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(</span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom =</span> <span class="st">"rect"</span>, </span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">xmin =</span> date_end_obs, <span class="at">xmax =</span> date_end_sample,</span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">ymin =</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="at">ymax =</span> <span class="cn">Inf</span>,</span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> .<span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"grey"</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_paper</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pred-oos-double-gompertz-uk" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="phenomenological-models_files/figure-html/fig-pred-oos-double-gompertz-uk-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;7.2: Predictions of the number of cases for the UK, with a double Gompertz model.</figcaption><p></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./phenomeological-background.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Background on Phenomenological Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>